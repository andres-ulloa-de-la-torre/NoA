<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoA: Engine for simulation of meta-agent ensembles as Worlds</title>
    <style>
        :root {
            --primary-color: #0E1117;
            --secondary-color: #262730;
            --accent-color: #FF4B4B;
            --text-color: #FAFAFA;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --border-radius: 0.5rem;
        }
        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 2rem;
            font-size: 16px;
            line-height: 1.6;
        }
        h1, h2 {
            color: var(--text-color);
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            border-bottom: none;
        }
        h2 {
            font-size: 1.75rem;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--primary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .section {
            background-color: var(--secondary-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .hidden {
            display: none;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input, textarea, button {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--secondary-color);
            background-color: #1C1E25;
            color: var(--text-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 75, 75, 0.3);
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        button {
            cursor: pointer;
            background-color: var(--accent-color);
            color: var(--text-color);
            font-weight: bold;
            border: none;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #E03C3C;
        }
        #log-container {
            height: 400px;
            background-color: #000;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            overflow-y: scroll;
            font-family: 'Menlo', 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            color: #C0C0C0;
        }
        #graph-container {
            min-height: 400px;
            background-color: var(--secondary-color);
            border: 1px dashed #444;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow: auto;
        }
        #graph-container p {
            color: #888;
        }
        .mbti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        #results-container pre {
            background-color: #000;
            padding: 1rem;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>WoA: Engine for simulation of meta-agent ensembles as Worlds</h1>

    <div class="container">
        <div id="graph-architecture" class="section">
            <h2>Graph Architecture</h2>
            <form id="graph-params-form">
                <label for="num_agents_per_principality">Number of agents per principality:</label>
                <input type="number" id="num_agents_per_principality" name="num_agents_per_principality" required>

                <label for="cot_trace_depth">CoT trace depth (max 32):</label>
                <input type="number" id="cot_trace_depth" name="cot_trace_depth" value="4" max="32" required>

                <label for="num_epochs">Number of epochs:</label>
                <input type="number" id="num_epochs" name="num_epochs" required>

                <label for="vector_word_size">Vector word size:</label>
                <input type="number" id="vector_word_size" name="vector_word_size" required>

                <label for="prompt_alignment">Prompt alignment (0.1-2.0):</label>
                <input type="number" id="prompt_alignment" name="prompt_alignment" step="0.1" min="0.1" max="2.0" value="1.0" required>

                <label for="density">Density (0.1-2.0):</label>
                <input type="number" id="density" name="density" step="0.1" min="0.1" max="2.0" value="1.0" required>

                <label for="num_reflections">Number of reflections (20 - max(cot_trace_depth * 16)):</label>
                <input type="number" id="num_reflections" name="num_reflections" min="20" required>

                <label for="learning_rate">Learning rate (0.1-2.0):</label>
                <input type="number" id="learning_rate" name="learning_rate" step="0.1" min="0.1" max="2.0" value="0.1" required>

                <label for="prompt">Prompt:</label>
                <textarea id="prompt" name="prompt" required></textarea>

                <button type="submit">Next</button>
            </form>
        </div>

        <div id="seeds-section" class="section hidden">
            <h2>Seeds for basis operators per principality</h2>
            <p>Use only verbs as operators instead of nouns or adjectives; the more abstract and linguistically loaded the verb is, the smoother the “loss” landscape will be.</p>
            <form id="seeds-form">
                <div class="mbti-grid" id="mbti-inputs"></div>
                <button type="submit">Build and Run Graph</button>
            </form>
        </div>
    </div>

    <div class="container">
        <h2>Real-time Graph Activity</h2>
        <div id="log-container"></div>
    </div>

    <div class="container">
        <h2>Graph Visualization</h2>
        <div id="graph-container">
            <p>Graph will be displayed here...</p>
        </div>
    </div>

    <div class="container hidden" id="results-container">
        <h2>Final Result</h2>
        <div id="final-solution"></div>
    </div>

    <script>
        const mbtiTypes = [
            "ISTJ", "ISFJ", "INFJ", "INTJ",
            "ISTP", "ISFP", "INFP", "INTP",
            "ESTP", "ESFP", "ENFP", "ENTP",
            "ESTJ", "ESFJ", "ENFJ", "ENTJ"
        ];

        const graphParamsForm = document.getElementById('graph-params-form');
        const seedsSection = document.getElementById('seeds-section');
        const mbtiInputs = document.getElementById('mbti-inputs');
        const seedsForm = document.getElementById('seeds-form');
        const logContainer = document.getElementById('log-container');
        const graphContainer = document.getElementById('graph-container');
        const resultsContainer = document.getElementById('results-container');
        const finalSolutionContainer = document.getElementById('final-solution');

        let vectorWordSize = 0;

        graphParamsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(graphParamsForm);
            const params = Object.fromEntries(formData.entries());
            vectorWordSize = parseInt(params.vector_word_size);

            const cotTraceDepth = parseInt(params.cot_trace_depth);
            const numReflectionsInput = document.getElementById('num_reflections');
            numReflectionsInput.max = cotTraceDepth * 16;

            mbtiInputs.innerHTML = '';
            mbtiTypes.forEach(type => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = type;
                const input = document.createElement('input');
                input.type = 'text';
                input.name = type;
                input.required = true;
                div.appendChild(label);
                div.appendChild(input);
                mbtiInputs.appendChild(div);
            });

            seedsSection.classList.remove('hidden');
        });

        seedsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(seedsForm);
            const seeds = Object.fromEntries(formData.entries());

            for (const type in seeds) {
                const words = seeds[type].split(' ').filter(w => w.length > 0);
                if (words.length > vectorWordSize) {
                    alert(`Number of words for ${type} cannot exceed ${vectorWordSize}`);
                    return;
                }
            }
            
            const graphParams = new FormData(graphParamsForm);
            const params = Object.fromEntries(graphParams.entries());
            
            logContainer.innerHTML = '<p>Building and running graph... This may take some time.</p>';
            resultsContainer.classList.add('hidden');
            graphContainer.innerHTML = '<p>Graph will be displayed here...</p>';


            const response = await fetch('/build_and_run_graph', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ params, seeds })
            });

            const result = await response.json();
            logContainer.innerHTML += `<p><strong>${result.message}</strong></p>`;
            
            if(result.mermaid_graph){
                graphContainer.innerHTML = result.mermaid_graph;
            }

            if(result.final_solution) {
                finalSolutionContainer.innerHTML = `
                    <h3>Proposed Solution</h3>
                    <pre><code>${result.final_solution.proposed_solution || 'N/A'}</code></pre>
                    <h3>Reasoning</h3>
                    <pre><code>${result.final_solution.reasoning || 'N/A'}</code></pre>
                    <h3>Skills Used</h3>
                    <p>${(result.final_solution.skills_used || []).join(', ')}</p>
                `;
                resultsContainer.classList.remove('hidden');
            }
        });

        const eventSource = new EventSource('/stream_log');
        eventSource.onmessage = function(event) {
            logContainer.innerHTML += `<p>${event.data}</p>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };

    </script>
</body>
</html>